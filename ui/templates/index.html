<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuhn Poker Solver</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --surface2: #0f3460;
            --accent: #e94560;
            --accent2: #533483;
            --text: #eee;
            --text-dim: #aaa;
            --p0-color: #4fc3f7;
            --p1-color: #ff8a65;
            --check-color: #66bb6a;
            --bet-color: #ef5350;
            --call-color: #66bb6a;
            --fold-color: #78909c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: var(--surface);
            padding: 12px 24px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 { font-size: 18px; color: var(--accent); }
        .header .info { font-size: 11px; color: var(--text-dim); }

        .controls {
            background: var(--surface);
            padding: 10px 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .controls label { font-size: 11px; color: var(--text-dim); }
        .controls input {
            background: var(--bg); border: 1px solid #444;
            color: var(--text); padding: 5px 10px;
            border-radius: 4px; width: 90px; font-family: inherit; font-size: 12px;
        }

        .controls button {
            background: var(--accent); border: none; color: white;
            padding: 6px 18px; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-weight: bold; font-size: 12px;
        }
        .controls button:hover { opacity: 0.9; }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-bar {
            padding: 6px 24px; background: var(--surface2); font-size: 11px;
            display: flex; gap: 24px;
        }
        .status-bar .stat { display: flex; gap: 6px; }
        .status-bar .stat-label { color: var(--text-dim); }
        .status-bar .stat-value { color: var(--accent); font-weight: bold; }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: calc(100vh - 100px);
        }

        /* Left: Game Tree Navigator */
        .tree-nav {
            background: var(--surface);
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 12px;
        }

        .tree-nav h2 {
            font-size: 11px; color: var(--text-dim); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 10px;
        }

        .tree-node {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 2px 0;
            font-size: 12px;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tree-node:hover { background: var(--surface2); }
        .tree-node.selected { background: var(--accent); color: white; }
        .tree-node.terminal { opacity: 0.7; }

        .tree-node .node-icon {
            width: 8px; height: 8px; border-radius: 50%;
            flex-shrink: 0;
        }
        .tree-node .node-icon.p0 { background: var(--p0-color); }
        .tree-node .node-icon.p1 { background: var(--p1-color); }
        .tree-node .node-icon.term { background: var(--fold-color); }

        .tree-children { margin-left: 16px; border-left: 1px solid #333; padding-left: 8px; }

        .tree-node .action-tag {
            font-size: 9px; padding: 1px 5px; border-radius: 3px;
            font-weight: bold;
        }
        .action-check { background: var(--check-color); color: #000; }
        .action-bet { background: var(--bet-color); color: #000; }
        .action-call { background: var(--call-color); color: #000; }
        .action-fold { background: var(--fold-color); color: #000; }

        /* Right: Detail Panel */
        .detail-panel {
            padding: 20px;
            overflow-y: auto;
        }

        .detail-panel h2 {
            font-size: 13px; color: var(--accent); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 12px;
        }

        .detail-panel h3 {
            font-size: 11px; color: var(--text-dim); text-transform: uppercase;
            letter-spacing: 1px; margin: 16px 0 8px 0;
        }

        /* Strategy Bars (poker solver style) */
        .strategy-section {
            background: var(--surface);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .hand-row {
            display: grid;
            grid-template-columns: 50px 1fr 120px 80px;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .hand-row:last-child { border-bottom: none; }

        .hand-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px; height: 36px;
            background: white; color: #333;
            border-radius: 4px; font-weight: bold;
            font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .card.j { color: #333; }
        .card.q { color: #c62828; }
        .card.k { color: #1565c0; }

        .action-bar {
            display: flex;
            height: 24px;
            border-radius: 3px;
            overflow: hidden;
        }

        .action-bar .seg {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #000;
            transition: width 0.3s ease;
            min-width: 0;
        }
        .seg-check { background: var(--check-color); }
        .seg-bet { background: var(--bet-color); }
        .seg-call { background: var(--call-color); }
        .seg-fold { background: var(--fold-color); }

        .prob-text {
            font-size: 11px;
            color: var(--text-dim);
        }

        .ev-text {
            font-size: 12px;
            font-weight: bold;
            text-align: right;
        }
        .ev-pos { color: var(--check-color); }
        .ev-neg { color: var(--bet-color); }
        .ev-zero { color: var(--text-dim); }

        /* Belief State Heatmap */
        .belief-section {
            background: var(--surface);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .belief-grid {
            display: grid;
            grid-template-columns: 80px repeat(6, 1fr);
            gap: 2px;
            font-size: 11px;
        }

        .belief-cell {
            padding: 8px 4px;
            text-align: center;
            border-radius: 2px;
        }

        .belief-header {
            background: var(--surface2);
            font-weight: bold;
            color: var(--text-dim);
            font-size: 10px;
        }

        .belief-label {
            text-align: right;
            padding-right: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* Node Info Card */
        .node-info {
            background: var(--surface);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .info-item {
            text-align: center;
        }
        .info-item .label {
            font-size: 10px; color: var(--text-dim);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .info-item .value {
            font-size: 16px; font-weight: bold; margin-top: 4px;
        }

        .breadcrumb {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }
        .breadcrumb .sep { color: #555; }
        .breadcrumb .crumb {
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        .breadcrumb .crumb:hover { background: var(--surface2); }
        .breadcrumb .crumb.current { background: var(--accent); color: white; }

        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-dim);
            font-size: 14px;
        }

        .pbs-explainer {
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.6;
            padding: 12px;
            background: var(--surface);
            border-radius: 6px;
            border-left: 3px solid var(--accent2);
        }

        .pbs-explainer strong { color: var(--text); }
        .pbs-explainer code {
            background: var(--surface2);
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 10px;
        }

        .tabs {
            display: flex; gap: 2px; margin-bottom: 16px;
        }
        .tabs button {
            background: var(--surface); border: none; color: var(--text-dim);
            padding: 8px 16px; cursor: pointer; font-family: inherit;
            font-size: 11px; border-radius: 4px 4px 0 0;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tabs button.active { background: var(--surface2); color: var(--accent); }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kuhn Poker Solver</h1>
        <div class="info">ReBeL-style PBS Explorer | Cards: J Q K | 2 Players</div>
    </div>

    <div class="controls">
        <label>CFR Iterations:</label>
        <input type="number" id="iterations" value="10000" min="100" step="1000">
        <button id="solve-btn" onclick="solve()">Solve</button>
        <span id="solve-status" style="font-size: 11px; color: var(--text-dim);"></span>
    </div>

    <div class="status-bar" id="status-bar">
        <div class="stat"><span class="stat-label">Status:</span> <span class="stat-value" id="stat-status">Not solved</span></div>
        <div class="stat"><span class="stat-label">Exploitability:</span> <span class="stat-value" id="stat-exploit">--</span></div>
        <div class="stat"><span class="stat-label">Iterations:</span> <span class="stat-value" id="stat-iters">--</span></div>
        <div class="stat"><span class="stat-label">Game Value (P0):</span> <span class="stat-value">-0.0556</span></div>
    </div>

    <div class="main-layout">
        <div class="tree-nav">
            <h2>Game Tree</h2>
            <div id="tree-container">
                <div class="placeholder" style="height:100px;font-size:12px;">Click Solve</div>
            </div>
        </div>

        <div class="detail-panel" id="detail-panel">
            <div class="placeholder">Click "Solve" to compute the Nash equilibrium, then select a node from the game tree.</div>
        </div>
    </div>

    <script>
    let treeData = null;
    let strategyData = null;
    let beliefData = null;
    let selectedHistory = "";

    const CARDS = ["J", "Q", "K"];
    const DEAL_LABELS = ["JQ", "JK", "QJ", "QK", "KJ", "KQ"];

    function cardClass(c) { return c.toLowerCase(); }

    function actionTag(code) {
        const map = {
            c_root: { label: "Check", cls: "action-check" },
            b_root: { label: "Bet", cls: "action-bet" },
            c_bet: { label: "Call", cls: "action-call" },
            f_bet: { label: "Fold", cls: "action-fold" },
        };
        return map[code] || { label: code, cls: "" };
    }

    function getActionLabels(history) {
        if (history === "" || history === "c") return [["c", "Check", "seg-check"], ["b", "Bet", "seg-bet"]];
        return [["c", "Call", "seg-call"], ["f", "Fold", "seg-fold"]];
    }

    async function solve() {
        const btn = document.getElementById("solve-btn");
        const status = document.getElementById("solve-status");
        const iters = parseInt(document.getElementById("iterations").value);
        btn.disabled = true;
        status.textContent = "Solving...";

        try {
            const resp = await fetch("/api/solve", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ iterations: iters }),
            });
            const data = await resp.json();
            document.getElementById("stat-status").textContent = "Solved";
            document.getElementById("stat-exploit").textContent = data.exploitability.toFixed(6);
            document.getElementById("stat-iters").textContent = data.iterations;

            await Promise.all([
                fetch("/api/tree").then(r => r.json()).then(d => { treeData = d; }),
                fetch("/api/strategy").then(r => r.json()).then(d => { strategyData = d; }),
                fetch("/api/beliefs").then(r => r.json()).then(d => { beliefData = d; }),
            ]);

            renderTree();
            selectNode("");
            status.textContent = "Done";
        } catch (e) {
            status.textContent = "Error: " + e.message;
        }
        btn.disabled = false;
    }

    function renderTree() {
        const container = document.getElementById("tree-container");
        container.innerHTML = renderTreeNode(treeData, 0, null);
    }

    function renderTreeNode(node, depth, actionInfo) {
        const h = node.history === "(root)" ? "" : node.history;
        const isTerm = node.is_terminal;
        const termCls = isTerm ? "terminal" : "";
        const selCls = h === selectedHistory ? "selected" : "";

        let iconCls = "term";
        if (!isTerm) iconCls = node.player === 0 ? "p0" : "p1";

        let label = h || "Root";
        let actionHtml = "";
        if (actionInfo) {
            const { code, parentH } = actionInfo;
            const facing = parentH === "" || parentH === "c" ? "root" : "bet";
            const tag = actionTag(code + "_" + facing);
            actionHtml = `<span class="action-tag ${tag.cls}">${tag.label}</span>`;
        }

        let evHtml = "";
        if (isTerm && node.ev_p0 !== undefined) {
            const cls = node.ev_p0 > 0 ? "ev-pos" : node.ev_p0 < 0 ? "ev-neg" : "ev-zero";
            evHtml = `<span class="${cls}" style="font-size:10px;margin-left:auto;">${node.ev_p0 >= 0 ? "+" : ""}${node.ev_p0.toFixed(3)}</span>`;
        }

        let html = `<div class="tree-node ${termCls} ${selCls}" onclick="selectNode('${h}')" data-history="${h}">`;
        html += `<span class="node-icon ${iconCls}"></span>`;
        html += actionHtml;
        html += `<span>${label}</span>`;
        html += evHtml;
        html += `</div>`;

        if (node.children) {
            html += `<div class="tree-children">`;
            for (const child of node.children) {
                const childH = child.history === "(root)" ? "" : child.history;
                html += renderTreeNode(child, depth + 1, { code: child.action_code, parentH: h });
            }
            html += `</div>`;
        }

        return html;
    }

    function selectNode(history) {
        selectedHistory = history;

        // Update tree selection
        document.querySelectorAll(".tree-node").forEach(n => {
            n.classList.toggle("selected", n.dataset.history === history);
        });

        renderDetail(history);
    }

    function renderDetail(history) {
        const panel = document.getElementById("detail-panel");
        if (!treeData || !strategyData || !beliefData) {
            panel.innerHTML = '<div class="placeholder">No data</div>';
            return;
        }

        const node = findNode(treeData, history);
        if (!node) return;

        const isTerm = node.is_terminal;
        const player = node.player;
        const playerLabel = player === 0 ? "P0 (OOP)" : "P1 (IP)";
        const playerColor = player === 0 ? "var(--p0-color)" : "var(--p1-color)";

        let html = "";

        // Breadcrumb
        html += renderBreadcrumb(history);

        // Node info card
        html += `<div class="node-info">`;
        html += `<div class="info-item"><div class="label">History</div><div class="value">${history || "Root"}</div></div>`;
        if (!isTerm) {
            html += `<div class="info-item"><div class="label">Acting Player</div><div class="value" style="color:${playerColor}">${playerLabel}</div></div>`;
        }
        html += `<div class="info-item"><div class="label">Type</div><div class="value">${isTerm ? "Terminal" : "Decision"}</div></div>`;
        if (node.ev_p0 !== undefined) {
            const cls = node.ev_p0 > 0 ? "ev-pos" : node.ev_p0 < 0 ? "ev-neg" : "ev-zero";
            html += `<div class="info-item"><div class="label">EV (P0)</div><div class="value ${cls}">${node.ev_p0 >= 0 ? "+" : ""}${node.ev_p0.toFixed(4)}</div></div>`;
        }
        html += `</div>`;

        // Tabs
        html += `<div class="tabs">`;
        html += `<button class="active" onclick="showDetailTab('strategy')">Strategy</button>`;
        html += `<button onclick="showDetailTab('beliefs')">Beliefs</button>`;
        html += `<button onclick="showDetailTab('reach')">Reach Probs</button>`;
        html += `</div>`;

        // Strategy section
        if (!isTerm && node.strategies) {
            html += `<div id="dtab-strategy">`;
            html += renderStrategySection(history, node, player);
            html += `</div>`;
        } else if (isTerm) {
            html += `<div id="dtab-strategy">`;
            html += renderTerminalPayoffs(history);
            html += `</div>`;
        } else {
            html += `<div id="dtab-strategy"><div class="placeholder" style="height:100px">No strategy data</div></div>`;
        }

        // Beliefs section
        html += `<div id="dtab-beliefs" style="display:none">`;
        html += renderBeliefSection(history);
        html += `</div>`;

        // Reach section
        html += `<div id="dtab-reach" style="display:none">`;
        html += renderReachSection(history);
        html += `</div>`;

        panel.innerHTML = html;
    }

    function showDetailTab(name) {
        ["strategy", "beliefs", "reach"].forEach(t => {
            const el = document.getElementById("dtab-" + t);
            if (el) el.style.display = t === name ? "" : "none";
        });
        document.querySelectorAll(".tabs button").forEach((btn, i) => {
            btn.classList.toggle("active", (i === 0 && name === "strategy") || (i === 1 && name === "beliefs") || (i === 2 && name === "reach"));
        });
    }

    function renderBreadcrumb(history) {
        let html = '<div class="breadcrumb">';
        html += `<span class="crumb ${history === '' ? 'current' : ''}" onclick="selectNode('')">Root</span>`;

        if (history.length > 0) {
            for (let i = 1; i <= history.length; i++) {
                const h = history.substring(0, i);
                const action = history[i - 1];
                const parentH = history.substring(0, i - 1);
                const facing = parentH === "" || parentH === "c" ? "root" : "bet";
                const tag = actionTag(action + "_" + facing);
                html += `<span class="sep">></span>`;
                html += `<span class="crumb ${h === history ? 'current' : ''}" onclick="selectNode('${h}')">${tag.label}</span>`;
            }
        }

        html += '</div>';
        return html;
    }

    function renderStrategySection(history, node, player) {
        const actions = getActionLabels(history);
        const handEvs = node.hand_evs || {};
        const actingPlayerKey = player === 0 ? "p0" : "p1";

        let html = `<div class="strategy-section">`;
        html += `<h3>Strategy at "${history || 'Root'}" (Player ${player})</h3>`;

        // Header
        html += `<div class="hand-row" style="border-bottom: 2px solid rgba(255,255,255,0.1);">`;
        html += `<div style="font-size:10px;color:var(--text-dim);">HAND</div>`;
        html += `<div style="font-size:10px;color:var(--text-dim);">ACTION FREQUENCY</div>`;
        html += `<div style="font-size:10px;color:var(--text-dim);">PROBABILITIES</div>`;
        html += `<div style="font-size:10px;color:var(--text-dim);text-align:right;">EV</div>`;
        html += `</div>`;

        for (const card of CARDS) {
            const key = card + "|" + history;
            const info = strategyData[key];
            if (!info) continue;

            html += `<div class="hand-row">`;
            html += `<div class="hand-label"><span class="card ${cardClass(card)}">${card}</span></div>`;

            // Action bar
            html += `<div class="action-bar">`;
            for (const [code, label, segCls] of actions) {
                const prob = info.raw_actions[code] || 0;
                const pct = (prob * 100).toFixed(0);
                html += `<div class="seg ${segCls}" style="width:${Math.max(prob * 100, 0.5)}%">${pct >= 15 ? pct + "%" : ""}</div>`;
            }
            html += `</div>`;

            // Text probabilities
            html += `<div class="prob-text">`;
            for (const [code, label, segCls] of actions) {
                const prob = info.raw_actions[code] || 0;
                html += `${label}: ${(prob * 100).toFixed(1)}%  `;
            }
            html += `</div>`;

            // EV for the acting player holding this card
            const playerEvs = handEvs[actingPlayerKey];
            if (playerEvs && playerEvs[card] !== undefined) {
                const ev = playerEvs[card];
                const cls = ev > 0.001 ? "ev-pos" : ev < -0.001 ? "ev-neg" : "ev-zero";
                html += `<div class="ev-text ${cls}">${ev >= 0 ? "+" : ""}${ev.toFixed(3)}</div>`;
            } else {
                html += `<div class="ev-text ev-zero">--</div>`;
            }
            html += `</div>`;
        }

        html += `</div>`;

        // Per-Hand EVs for both players
        html += renderHandEvsSection(node);

        // Deal Probabilities
        html += renderDealProbsSection(node);

        return html;
    }

    function renderHandEvsSection(node) {
        const handEvs = node.hand_evs;
        if (!handEvs || (!Object.keys(handEvs.p0 || {}).length && !Object.keys(handEvs.p1 || {}).length)) {
            return '';
        }

        let html = `<div class="strategy-section">`;
        html += `<h3>Per-Hand Expected Values</h3>`;

        html += `<div style="display:grid;grid-template-columns:auto repeat(3,1fr);gap:2px;font-size:11px;">`;
        html += `<div class="belief-cell belief-header">Player</div>`;
        for (const c of CARDS) {
            html += `<div class="belief-cell belief-header">${c}</div>`;
        }

        // P0 row
        html += `<div class="belief-cell belief-label" style="color:var(--p0-color)">P0</div>`;
        for (const c of CARDS) {
            const ev = (handEvs.p0 || {})[c];
            if (ev !== undefined) {
                const cls = ev > 0.001 ? "ev-pos" : ev < -0.001 ? "ev-neg" : "ev-zero";
                html += `<div class="belief-cell ${cls}" style="font-weight:bold;">${ev >= 0 ? "+" : ""}${ev.toFixed(4)}</div>`;
            } else {
                html += `<div class="belief-cell ev-zero">--</div>`;
            }
        }

        // P1 row
        html += `<div class="belief-cell belief-label" style="color:var(--p1-color)">P1</div>`;
        for (const c of CARDS) {
            const ev = (handEvs.p1 || {})[c];
            if (ev !== undefined) {
                const cls = ev > 0.001 ? "ev-pos" : ev < -0.001 ? "ev-neg" : "ev-zero";
                html += `<div class="belief-cell ${cls}" style="font-weight:bold;">${ev >= 0 ? "+" : ""}${ev.toFixed(4)}</div>`;
            } else {
                html += `<div class="belief-cell ev-zero">--</div>`;
            }
        }
        html += `</div>`;

        html += `<div style="margin-top:8px;font-size:10px;color:var(--text-dim);">`;
        html += `EV of holding each card at this node (from that player's perspective). Zero-sum: P0 gain = P1 loss.`;
        html += `</div>`;

        html += `</div>`;
        return html;
    }

    function renderDealProbsSection(node) {
        const dealProbs = node.deal_probs;
        if (!dealProbs || dealProbs.length === 0) return '';

        let html = `<div class="strategy-section">`;
        html += `<h3>Deal Probabilities (Most Likely)</h3>`;

        const maxProb = dealProbs[0].prob;

        for (const dp of dealProbs) {
            const pct = (dp.prob * 100).toFixed(1);
            const barW = (dp.prob / maxProb * 100).toFixed(1);
            const c0 = dp.deal[0], c1 = dp.deal[1];

            html += `<div style="display:grid;grid-template-columns:60px 1fr 60px;align-items:center;gap:8px;padding:4px 0;">`;
            html += `<div style="display:flex;gap:4px;">`;
            html += `<span class="card ${cardClass(c0)}" style="width:22px;height:28px;font-size:12px;">${c0}</span>`;
            html += `<span class="card ${cardClass(c1)}" style="width:22px;height:28px;font-size:12px;">${c1}</span>`;
            html += `</div>`;
            html += `<div style="height:18px;background:var(--surface2);border-radius:3px;overflow:hidden;">`;
            html += `<div style="width:${barW}%;height:100%;background:var(--accent2);border-radius:3px;"></div>`;
            html += `</div>`;
            html += `<div style="font-size:11px;text-align:right;color:var(--text-dim);">${pct}%</div>`;
            html += `</div>`;
        }

        html += `<div style="margin-top:8px;font-size:10px;color:var(--text-dim);">`;
        html += `Joint probability of each deal given the public history. Computed from reach probabilities.`;
        html += `</div>`;

        html += `</div>`;
        return html;
    }

    function renderTerminalPayoffs(history) {
        let html = `<div class="strategy-section">`;
        html += `<h3>Terminal Payoffs at "${history}"</h3>`;

        // Find the belief data for this terminal
        const entry = beliefData.histories.find(e => {
            const eh = e.history === "(root)" ? "" : e.history;
            return eh === history;
        });

        if (entry && entry.payoffs) {
            html += `<div style="display:grid;grid-template-columns:auto repeat(6,1fr);gap:2px;font-size:11px;">`;
            html += `<div class="belief-cell belief-header"></div>`;
            for (const dl of DEAL_LABELS) {
                html += `<div class="belief-cell belief-header">${dl}</div>`;
            }

            html += `<div class="belief-cell belief-label">P0</div>`;
            for (const p of entry.payoffs) {
                const cls = p.p0 > 0 ? "ev-pos" : p.p0 < 0 ? "ev-neg" : "ev-zero";
                html += `<div class="belief-cell ${cls}">${p.p0 > 0 ? "+" : ""}${p.p0}</div>`;
            }

            html += `<div class="belief-cell belief-label">P1</div>`;
            for (const p of entry.payoffs) {
                const cls = p.p1 > 0 ? "ev-pos" : p.p1 < 0 ? "ev-neg" : "ev-zero";
                html += `<div class="belief-cell ${cls}">${p.p1 > 0 ? "+" : ""}${p.p1}</div>`;
            }
            html += `</div>`;
        }

        html += `</div>`;
        return html;
    }

    function renderBeliefSection(history) {
        const entry = beliefData.histories.find(e => {
            const eh = e.history === "(root)" ? "" : e.history;
            return eh === history;
        });

        if (!entry) return '<div class="belief-section"><p style="color:var(--text-dim);">No belief data for this node.</p></div>';

        const pbs = entry.pbs;
        const cardLabels = beliefData.card_labels || CARDS;

        let html = `<div class="belief-section">`;
        html += `<h3>Public Belief State: P(card | history = "${history || 'root'}")</h3>`;

        // Per-player PBS table
        html += `<div style="display:grid;grid-template-columns:auto repeat(${cardLabels.length},1fr);gap:2px;font-size:11px;">`;
        html += `<div class="belief-cell belief-header">Player</div>`;
        for (const cl of cardLabels) {
            html += `<div class="belief-cell belief-header">${cl}</div>`;
        }

        // Player 0 row
        html += `<div class="belief-cell belief-label" style="color:var(--p0-color)">P0</div>`;
        for (let i = 0; i < pbs.p0.length; i++) {
            const b = pbs.p0[i];
            const opacity = Math.min(b * 4, 1).toFixed(2);
            const bg = `rgba(79, 195, 247, ${opacity})`;
            html += `<div class="belief-cell" style="background:${bg}">${(b * 100).toFixed(1)}%</div>`;
        }

        // Player 1 row
        html += `<div class="belief-cell belief-label" style="color:var(--p1-color)">P1</div>`;
        for (let i = 0; i < pbs.p1.length; i++) {
            const b = pbs.p1[i];
            const opacity = Math.min(b * 4, 1).toFixed(2);
            const bg = `rgba(255, 138, 101, ${opacity})`;
            html += `<div class="belief-cell" style="background:${bg}">${(b * 100).toFixed(1)}%</div>`;
        }
        html += `</div>`;

        // Side-by-side bar chart
        html += `<div style="margin-top:12px;display:flex;height:60px;align-items:flex-end;gap:8px;">`;
        for (let i = 0; i < cardLabels.length; i++) {
            const b0 = pbs.p0[i], b1 = pbs.p1[i];
            const h0 = Math.max(b0 * 180, 2), h1 = Math.max(b1 * 180, 2);
            html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;">`;
            html += `<div style="display:flex;gap:2px;align-items:flex-end;height:50px;">`;
            html += `<div style="width:14px;height:${h0}px;background:var(--p0-color);border-radius:2px 2px 0 0;"></div>`;
            html += `<div style="width:14px;height:${h1}px;background:var(--p1-color);border-radius:2px 2px 0 0;"></div>`;
            html += `</div>`;
            html += `<div style="font-size:9px;color:var(--text-dim);margin-top:2px;">${cardLabels[i]}</div>`;
            html += `</div>`;
        }
        html += `</div>`;

        html += `</div>`;

        html += `<div class="pbs-explainer">`;
        html += `<strong>PBS(h)</strong> = (h, <span style="color:var(--p0-color)">&Delta;(S<sub>0</sub>)</span>, <span style="color:var(--p1-color)">&Delta;(S<sub>1</sub>)</span>) &mdash; per-player belief over private states<br>`;
        html += `Each column shows the probability that the player holds each card, given the public history. `;
        html += `In ReBeL, the value network <code>V(PBS)</code> takes this [3,2] tensor as input.`;
        html += `</div>`;

        return html;
    }

    function renderReachSection(history) {
        const entry = beliefData.histories.find(e => {
            const eh = e.history === "(root)" ? "" : e.history;
            return eh === history;
        });

        if (!entry) return '<div class="belief-section"><p style="color:var(--text-dim);">No reach data.</p></div>';

        let html = `<div class="belief-section">`;
        html += `<h3>Reach Probabilities at "${history || 'root'}"</h3>`;

        html += `<div class="belief-grid">`;
        html += `<div class="belief-cell belief-header">Deal</div>`;
        for (const dl of DEAL_LABELS) {
            html += `<div class="belief-cell belief-header">${dl}</div>`;
        }

        // P0 reach
        html += `<div class="belief-cell belief-label" style="color:var(--p0-color)">P0 Reach</div>`;
        for (let i = 0; i < entry.reach_p0.length; i++) {
            const r = entry.reach_p0[i];
            const opacity = Math.min(r, 1).toFixed(2);
            html += `<div class="belief-cell" style="background:rgba(79,195,247,${opacity})">${r.toFixed(4)}</div>`;
        }

        // P1 reach
        html += `<div class="belief-cell belief-label" style="color:var(--p1-color)">P1 Reach</div>`;
        for (let i = 0; i < entry.reach_p1.length; i++) {
            const r = entry.reach_p1[i];
            const opacity = Math.min(r, 1).toFixed(2);
            html += `<div class="belief-cell" style="background:rgba(255,138,101,${opacity})">${r.toFixed(4)}</div>`;
        }

        // Joint (belief unnormalized)
        html += `<div class="belief-cell belief-label">Joint</div>`;
        for (let i = 0; i < entry.reach_p0.length; i++) {
            const joint = entry.reach_p0[i] * entry.reach_p1[i] / 6.0;
            const opacity = Math.min(joint * 20, 1).toFixed(2);
            html += `<div class="belief-cell" style="background:rgba(186,104,200,${opacity})">${joint.toFixed(6)}</div>`;
        }

        html += `</div>`;
        html += `</div>`;

        return html;
    }

    function findNode(node, history) {
        const nodeH = node.history === "(root)" ? "" : node.history;
        if (nodeH === history) return node;
        if (node.children) {
            for (const child of node.children) {
                const found = findNode(child, history);
                if (found) return found;
            }
        }
        return null;
    }

    // Auto-load if already solved
    fetch("/api/info").then(r => r.json()).then(data => {
        if (data.solved) {
            document.getElementById("stat-status").textContent = "Solved";
            document.getElementById("stat-exploit").textContent = data.exploitability.toFixed(6);
            document.getElementById("stat-iters").textContent = data.iterations;
            Promise.all([
                fetch("/api/tree").then(r => r.json()).then(d => { treeData = d; }),
                fetch("/api/strategy").then(r => r.json()).then(d => { strategyData = d; }),
                fetch("/api/beliefs").then(r => r.json()).then(d => { beliefData = d; }),
            ]).then(() => {
                renderTree();
                selectNode("");
            });
        }
    });
    </script>
</body>
</html>
